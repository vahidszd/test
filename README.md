# FBCM(Fast Beam Conditions Monitor) Simulation With CMSSW
Full CMSSW simulations, including an appropriate model for the front-end electronics, were performed to assess the performance of the proposed system and to optimize some of its parameters. The simulations were implemented in a private branch of CMSSW 11 2 0 pre10, including the FBCM geometry, detector simulation using GEANT4, and a customized digitizer. 
## In order to use this simulation, we need to follow the following steps:
* **Setup workspace for FBCM simulation in CMSSW_11_2_X**
  * Setup your CMS_11_2_X
    ```sh
    cd <YourWorkDir>
    cmsrel CMSSW_11_2_0_pre10
    cd CMSSW_11_2_0_pre10/src
    cmsenv
    cd ..
    ```
   *    after setting scram environment variables, please go to release base directory. Copy the [setup          file](https://github.com/m-sedghi/cmssw/blob/CMSSW_11_2_FbcmBcm1f/SimFbcm) to the  CMSSW_11_2_0_pre10 directory and type 
         ```sh
         chmod +x Setup_Fbcm_CMSSW_11_2_X.sh
         ./Setup_Fbcm_CMSSW_11_2_X.sh
        ```
   
* **Generating MiniBias events with pythia**
   * Go to the  directory where MiniBias generating configuration file located
     ```sh
     cd <YourWorkDir>/CMSSW_11_2_0_pre10/src/SimFbcm/SampleConfigs/Fbcm2022Aug
     ls
     ```
      then you can find **MinBias_14TeV_pythia8_TuneCUETP8M1_cfg.py** Python script which generated by 
       ```sh
        cmsDriver.py --evt_type MinBias_14TeV_pythia8_TuneCUETP8M1_cfi -s GEN,SIM --mc --fileout file:MinBias_14TeV_pythia8_TuneCUETP8M1_GEN_SIM.root --conditions auto:phase2_realistic --era Phase2  --datatier GEN-SIM --geometry Extended2026D81 --eventcontent FEVTDEBUG --pileup=NoPileUp --python_filename MinBias_14TeV_pythia8_TuneCUETP8M1_cfg.py --customise Configuration/DataProcessing/Utils.addMonitoring --nThreads 8 -n 40 --no_exe
        ```
       command. Now you can generate your own configuration file with other options. For example change the  `--python_filename MinBias_14TeV_pythia8_TuneCUETP8M1_cfg.py` to `--python_filename New_MinBias_14TeV_pythia8_TuneCUETP8M1_cfg.py` to generate another configuration file named **New_MinBias_14TeV_pythia8_TuneCUETP8M1_cfg.py**.
    * Let's test it locally. Type 
      ```sh
      cmsRun  MinBias_14TeV_pythia8_TuneCUETP8M1_cfg.py
      ```
      to generate MinBias events. It take few minute for the script to do it's job (please be patient). When the script done it's job successfully, you should find a root file in the same directory named **MinBias_14TeV_pythia8_TuneCUETP8M1_GEN_SIM.root** in which the generated MiniBias events stored.
     * We need many of MiniBias events and we can't generate them locally as we have done. We need to submit the **MinBias_14TeV_pythia8_TuneCUETP8M1_cfg.py** to the crab or condor to generate millions of MiniBias events. To do so we need to wright a Crab or Condor submit script. Here is the sample of the crab submit file which you can find it in  **CMSSW_11_2_0_pre10/src/SimFbcm/SampleConfigs/CrabSamples2SubmitJobs/v0** directory.
       ```py
       from WMCore.Configuration import Configuration
       import os,sys
       config = Configuration()

       config.section_('General')
       config.General.requestName = 'FBCMMinBiasGeneration'
       config.General.workArea = 'crab_projects'
       config.General.transferOutputs = True

       config.section_('JobType')
       config.JobType.pluginName = 'PrivateMC'
       config.JobType.psetName = 'MinBias_14TeV_pythia8_TuneCUETP8M1_cfg.py'
       config.JobType.allowUndistributedCMSSW = True
       config.JobType.maxJobRuntimeMin = 3000
       config.JobType.sendPythonFolder	 = True
       config.JobType.numCores = 8
       config.JobType.maxMemoryMB = 10000
       config.JobType.maxJobRuntimeMin = 5000

       config.section_('Data')
       config.Data.outputPrimaryDataset = 'MinBias'
       config.Data.splitting = 'EventBased'
       config.Data.unitsPerJob = 2000
       config.Data.totalUnits = 1000000 #config.Data.unitsPerJob * NJOBS
       config.Data.publication = True
       config.Data.outputDatasetTag = 'FBCMMinBias'
       config.Data.outLFNDirBase = '/store/group/dpg_bril/comm_bril/phase2-sim/FBCM/'

       config.section_("Site")
       config.Site.storageSite = "T2_CH_CERN"
       ```
  * As you see This script cotains different sections seperated with empty line. You can study more about these sections on [CRAB configuration file](https://twiki.cern.ch/twiki/bin/view/CMSPublic/CRAB3ConfigurationFile). We have already produced five milion MiniBias events stored in 1000 root files and have stored them in **/eos/cms/store/group/dpg_bril/comm_bril/phase2-sim/FBCM/Aug2022Workshop/MinBias/FBCMV2MinBias/220820_202455/0000**.
  * To submit jobs to the Crab you need to have permission. Once you get your permition to use crab, you need to get your ticket ass follow
    ```sh
    voms-proxy-init
    ```
    the out put should be like
    ```sh
    Enter GRID pass phrase for this identity:*****
    ```
    then enter your pass phrase and you get 
    ```sh
    Created proxy in /tmp/x509up_u151705.

    Your proxy is valid until Sun Nov 27 04:50:20 CET 2022
    ```  
    now you can submit your script to the Crab by
    ```sh
     crab submit -c crabMinBias_cfg_v0.py
     ```
     **crabDIGI_cfg.py** is called Crab configuration file which you have seen it above. Once you submit the config file, you must see output as
     ```sh
     Will use CRAB configuration file crabMinBias_cfg_v0.py
     Importing CMSSW configuration 
    Finished importing CMSSW configuration MinBias_14TeV_pythia8_TuneCUETP8M1_cfg.py
    Sending the request to the server at cmsweb.cern.ch
    Success: Your task has been delivered to the prod CRAB3 server.
    Task name: 221016_125238:vsedighz_crab_FBCMMiniBias
    Project dir: crab_lastAll/crab_FBCMMiniBias
    Please use ' crab status -d crab_lastAll/crab_FBCMMiniBias ' to check how the submission process proceeds.
    Log file is /afs/cern.ch/user/v/vsedighz/private/NewFbcm/last/CMSSW_11_2_0_pre10/src/SimFbcm/SampleConfigs/CrabSamples2SubmitJobs/v3CrabAug2022/crab_lastAll/crab_FBCMDIGIPU1/crab.log
    ```
* **Generatiin, Simulating and Degitizing**
  * The FBCM digitizer emulates the functionality of the front-end ASIC and significantly affects the linearity behavior.
  * Now go to **CMSSW_11_2_0_pre10/src/SimFbcm/SampleConfigs/CrabSamples2SubmitJobs/v3CrabAug2022** directory and  list the contet of the directory. there should be a python script named  **GEN_SIM_DIGI_M2_cfg.py** . This is the main code which has been created by 
    ```sh
    cmsDriver.py --evt_type SingleNuE10_cfi -s GEN,SIM,DIGI --mc --fileout file:GEN_SIM_DIGI.root --conditions auto:phase2_realistic --pileup_input file:MinBias_14TeV_pythia8_TuneCUETP8M1_GEN_SIM.root --pileup "AVE_200_BX_25ns,{'B':(-3,3),'N':1.5}" --era Phase2,fbcmDigi,OnlyfbcmDigi --datatier GEN-SIM-DIGI-RAW --geometry Extended2026D81 --eventcontent FEVTDEBUG --python_filename GEN_SIM_DIGI_cfg.py --customise   SimFbcm/SiPadDigitizer/aging.no_aging,Configuration/DataProcessing/Utils.addMonitoring --nThreads 2 -n 2 --no_exe 
    ```
  * Again you can test it by runing it locally. But it's better to modify some of it's lines to reduce it's running time. look at lines 23, 24 and 25. 
    ```py
    baseDirectory ='/eos/cms/store/group/dpg_bril/comm_bril/phase2-sim/FBCM/Aug2022Workshop/MinBias/FBCMV2MinBias/220820_202455'
    minBiasFiles = getInputFileList(baseDirectory, "MinBias" )
    #minBiasFiles = [minBiasFiles[0]]
    ```
  * As you see the last line is commented by '#'. Delet the '#' and comment above line. It should look like
    ```py
    baseDirectory ='/eos/cms/store/group/dpg_bril/comm_bril/phase2-sim/FBCM/Aug2022Workshop/MinBias/FBCMV2MinBias/220820_202455'
    #minBiasFiles = getInputFileList(baseDirectory, "MinBias" )
    minBiasFiles = [minBiasFiles[0]]
      ```
       Now the script uses only one of the root files generated in privious step.